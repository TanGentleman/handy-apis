# API Reference

The Modal-deployed API provides programmatic access to all scraper functionality.

## CLI Commands

### Basic
```bash
docpull sites                        # List available sites
docpull links <site-id>              # Get all doc links
docpull content <site-id> <path>     # Fetch single page
docpull index <site-id>              # Bulk fetch entire site
docpull download <site-id>           # Download site as ZIP
```

### Bulk Jobs
```bash
docpull bulk urls.txt                # Submit parallel scrape job
docpull job <job_id>                 # Check job status
docpull job <job_id> --watch         # Watch live progress
docpull jobs                         # List recent jobs
```

### Export
```bash
docpull export urls.txt              # Export URLs as ZIP (cached only)
docpull export urls.txt --scrape     # Export with fresh scraping
docpull export urls.txt --unzip      # Auto-extract after download
```

### Cache
```bash
docpull cache stats                  # Show cache statistics
docpull cache keys [site-id]         # List cached URLs
docpull cache clear <site-id>        # Clear cache for a site
```

## REST API

### Sites
```
GET  /sites                    # List all configured sites
GET  /sites/{id}/links         # Get all doc links (?max_age=0 to force refresh)
GET  /sites/{id}/content       # Get markdown (?path=/docs/guide)
POST /sites/{id}/index         # Bulk fetch (?max_concurrent=50)
GET  /sites/{id}/download      # Download as ZIP
```

### Discovery
```
GET  /discover?url=<url>       # Analyze page, suggest config
```

### Bulk Jobs
```
POST /jobs/bulk                # Submit job (body: {"urls": [...]})
GET  /jobs/{job_id}            # Get job status
GET  /jobs?limit=20            # List recent jobs
```

### Export
```
POST /export/zip               # Export URLs as ZIP
     body: {"urls": [...], "cached_only": true, "include_manifest": true}
```

### Cache
```
GET    /cache/stats            # Cache statistics
GET    /cache/keys             # List cached URLs (?site_id=modal)
DELETE /cache/{site_id}        # Clear cache for site
```

## Site Configuration

Sites are defined in `config/sites.json`:

| Field | Description |
|-------|-------------|
| `baseUrl` | Root URL (e.g., `"https://modal.com"`) |
| `mode` | `fetch` (fast) or `browser` (JS-heavy) |
| `links.startUrls` | Entry points for crawling |
| `links.maxDepth` | Recursion depth (fetch mode) |
| `links.pattern` | Regex to filter URLs |
| `content.selector` | CSS/XPath selector for content |
| `content.method` | `inner_html` or `click_copy` |

## Environment

Auto-generated by `deploy.py` in `.env`:

```
SCRAPER_API_URL=https://your-workspace--content-scraper-api-fastapi-app.modal.run
```

## Development

```bash
# Hot-reload API + UI locally
modal serve api/server.py

# Deploy
python deploy.py
```
