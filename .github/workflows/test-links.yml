# Test Links Workflow
#
# Fetches documentation links from all configured sites to verify the links endpoint.
# Sites are read from sites.json and tested in parallel using a matrix strategy.

name: Test Links

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - prod
          - dev
      site:
        description: 'Site to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - modal
          - convex
          - datadog
          - terraform-aws
          - cursor
          - claude-platform
          - claude-code
          - unsloth
          - playwright
          - whatnot
          - corridor

jobs:
  get-sites:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.sites.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Health check
        id: health
        env:
          ENVIRONMENT: ${{ inputs.environment || 'prod' }}
          MODAL_USERNAME: ${{ secrets.MODAL_USERNAME }}
          MODAL_KEY: ${{ secrets.MODAL_KEY }}
          MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
        run: |
          SUFFIX=""
          if [ "$ENVIRONMENT" = "dev" ]; then SUFFIX="-dev"; fi
          API_BASE="https://${MODAL_USERNAME}--content-scraper-api-fastapi-app${SUFFIX}.modal.run"

          echo "Checking API health at $API_BASE..."
          RESPONSE=$(curl -sf "$API_BASE/" \
            -H "Modal-Key: ${MODAL_KEY}" \
            -H "Modal-Secret: ${MODAL_SECRET}")

          echo "$RESPONSE" | jq .
          echo "API is healthy"

      - name: Build matrix from sites.json
        id: sites
        env:
          SELECTED_SITE: ${{ inputs.site || 'all' }}
        run: |
          if [ "$SELECTED_SITE" = "all" ]; then
            MATRIX=$(jq -c '{include: [.sites | to_entries[] | {id: .key, testPath: .value.testPath}]}' scraper/config/sites.json)
          else
            MATRIX=$(jq -c --arg site "$SELECTED_SITE" '{include: [.sites | to_entries[] | select(.key == $site) | {id: .key, testPath: .value.testPath}]}' scraper/config/sites.json)
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  test-links:
    needs: get-sites
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.get-sites.outputs.matrix) }}

    steps:
      - name: Test links for ${{ matrix.id }}
        env:
          ENVIRONMENT: ${{ inputs.environment || 'prod' }}
          MODAL_USERNAME: ${{ secrets.MODAL_USERNAME }}
          MODAL_KEY: ${{ secrets.MODAL_KEY }}
          MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
        run: |
          SUFFIX=""
          if [ "$ENVIRONMENT" = "dev" ]; then SUFFIX="-dev"; fi
          API_BASE="https://${MODAL_USERNAME}--content-scraper-api-fastapi-app${SUFFIX}.modal.run"

          echo "Testing links for ${{ matrix.id }}..."
          RESPONSE=$(curl -sf "${API_BASE}/sites/${{ matrix.id }}/links?max_age=0" \
            -H "Modal-Key: ${MODAL_KEY}" \
            -H "Modal-Secret: ${MODAL_SECRET}")

          COUNT=$(echo "$RESPONSE" | jq -r '.count')
          echo "Found $COUNT links"
          echo "### ${{ matrix.id }}: ${COUNT} links" >> $GITHUB_STEP_SUMMARY
