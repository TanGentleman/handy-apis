# Test Links Workflow
#
# Fetches documentation links from all configured sites to verify the links endpoint.
# Sites are tested in parallel using a matrix strategy.

name: Test Links

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - prod
          - dev

jobs:
  test-links:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          - modal
          - convex
          - datadog
          - terraform-aws
          - cursor
          - claude-platform
          - claude-code
          - unsloth
          - playwright

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install httpx

      - name: Test links for ${{ matrix.site }}
        env:
          ENVIRONMENT: ${{ inputs.environment || 'prod' }}
          MODAL_USERNAME: ${{ secrets.MODAL_USERNAME }}
          MODAL_KEY: ${{ secrets.MODAL_KEY }}
          MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
        run: |
          echo "Testing links endpoint for ${{ matrix.site }}..."
          OUTPUT=$(python docpull.py links "${{ matrix.site }}" --force 2>&1)
          echo "$OUTPUT"
          COUNT=$(echo "$OUTPUT" | grep -oP 'Total: \K\d+')
          echo "### ${{ matrix.site }}: ${COUNT} links" >> $GITHUB_STEP_SUMMARY
