# Test Content Workflow
#
# Fetches one piece of content from each configured site to verify the content endpoint.
# Sites and test paths are read from sites.json and tested in parallel.

name: Test Content

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - prod
          - dev
      site:
        description: 'Site to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - modal
          - convex
          - datadog
          - terraform-aws
          - cursor
          - claude-platform
          - claude-code
          - unsloth
          - playwright
          - whatnot
          - corridor

jobs:
  get-sites:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.sites.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Health check
        id: health
        env:
          ENVIRONMENT: ${{ inputs.environment || 'prod' }}
          MODAL_USERNAME: ${{ secrets.MODAL_USERNAME }}
          MODAL_KEY: ${{ secrets.MODAL_KEY }}
          MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
        run: |
          SUFFIX=""
          if [ "$ENVIRONMENT" = "dev" ]; then SUFFIX="-dev"; fi
          API_BASE="https://${MODAL_USERNAME}--content-scraper-api-fastapi-app${SUFFIX}.modal.run"

          echo "Checking API health at $API_BASE..."
          RESPONSE=$(curl -sf "$API_BASE/" \
            -H "Modal-Key: ${MODAL_KEY}" \
            -H "Modal-Secret: ${MODAL_SECRET}")

          echo "$RESPONSE" | jq .
          echo "API is healthy"

      - name: Build matrix from sites.json
        id: sites
        env:
          SELECTED_SITE: ${{ inputs.site || 'all' }}
        run: |
          if [ "$SELECTED_SITE" = "all" ]; then
            MATRIX=$(jq -c '{include: [.sites | to_entries[] | {id: .key, testPath: .value.testPath}]}' scraper/config/sites.json)
          else
            MATRIX=$(jq -c --arg site "$SELECTED_SITE" '{include: [.sites | to_entries[] | select(.key == $site) | {id: .key, testPath: .value.testPath}]}' scraper/config/sites.json)
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  test-content:
    needs: get-sites
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.get-sites.outputs.matrix) }}

    steps:
      - name: Test content for ${{ matrix.id }}
        env:
          ENVIRONMENT: ${{ inputs.environment || 'prod' }}
          MODAL_USERNAME: ${{ secrets.MODAL_USERNAME }}
          MODAL_KEY: ${{ secrets.MODAL_KEY }}
          MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
        run: |
          SUFFIX=""
          if [ "$ENVIRONMENT" = "dev" ]; then SUFFIX="-dev"; fi
          API_BASE="https://${MODAL_USERNAME}--content-scraper-api-fastapi-app${SUFFIX}.modal.run"

          # URL encode the path
          ENCODED_PATH=$(printf '%s' "${{ matrix.testPath }}" | jq -sRr @uri)

          echo "Testing content for ${{ matrix.id }} (${{ matrix.testPath }})..."
          URL="${API_BASE}/sites/${{ matrix.id }}/content?path=${ENCODED_PATH}&max_age=0"

          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" "$URL" \
            -H "Modal-Key: ${MODAL_KEY}" \
            -H "Modal-Secret: ${MODAL_SECRET}")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::HTTP $HTTP_CODE for ${{ matrix.id }}"
            cat /tmp/response.json
            exit 1
          fi

          RESPONSE=$(cat /tmp/response.json)
          CACHED=$(echo "$RESPONSE" | jq -r '.from_cache')
          CONTENT_LEN=$(echo "$RESPONSE" | jq -r '.content | length')

          STATUS="fresh"
          if [ "$CACHED" = "true" ]; then STATUS="cached"; fi

          echo "${CONTENT_LEN} chars (${STATUS})"

          # Fail if no content was returned
          if [ "$CONTENT_LEN" -eq 0 ]; then
            echo "::error::No content returned for ${{ matrix.id }}"
            exit 1
          fi

          echo "### ${{ matrix.id }}: ${CONTENT_LEN} chars (${STATUS})" >> $GITHUB_STEP_SUMMARY
