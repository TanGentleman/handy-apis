# Test Content Workflow
#
# Fetches one piece of content from each configured site to verify the content endpoint.
# Sites are tested in parallel using a matrix strategy.

name: Test Content

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - prod
          - dev

jobs:
  test-content:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - site: modal
            path: /guide/dicts
          - site: convex
            path: /functions/http-actions
          - site: datadog
            path: /tracing/trace_explorer
          - site: terraform-aws
            path: /resources/acm_certificate
          - site: cursor
            path: /agent/browser
          - site: claude-platform
            path: /agent-sdk/mcp
          - site: claude-code
            path: /headless
          - site: unsloth
            path: /basics/chat-templates
          - site: playwright
            path: /evaluating

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install httpx

      - name: Build API URL
        id: api
        run: |
          ENV="${{ inputs.environment }}"
          if [ "$ENV" = "dev" ]; then
            URL_SUFFIX="-dev"
          else
            URL_SUFFIX=""
          fi
          BASE_URL="https://${{ secrets.MODAL_USERNAME }}--content-scraper-api-fastapi-app${URL_SUFFIX}.modal.run"
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "Using environment: $ENV"
          echo "API URL: $BASE_URL"

      - name: Test content for ${{ matrix.site }}
        env:
          SCRAPER_API_URL: ${{ steps.api.outputs.base_url }}
          MODAL_KEY: ${{ secrets.MODAL_KEY }}
          MODAL_SECRET: ${{ secrets.MODAL_SECRET }}
        run: |
          echo "Testing content endpoint for ${{ matrix.site }} (${{ matrix.path }})..."
          python docpull.py content "${{ matrix.site }}" "${{ matrix.path }}" --force
